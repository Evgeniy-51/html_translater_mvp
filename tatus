warning: in the working copy of 'main.py', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/core/translator.py', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/parsers/span_merger.py', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/prompts/prompt_template.py', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/config.py b/config.py[m
[1mindex 78f6ec4..93a1fcf 100644[m
[1m--- a/config.py[m
[1m+++ b/config.py[m
[36m@@ -1,5 +1,5 @@[m
[31m-MODE = "test"[m
[31m-# MODE = "work"[m
[32m+[m[32m# MODE = "test"[m
[32m+[m[32mMODE = "work"[m
 [m
 INPUT_LANGUAGE = "english"[m
 # INPUT_LANGUAGE = "chinese"[m
[36m@@ -28,3 +28,5 @@[m [mTARGET_LANGUAGE = "russian"[m
 # OPENAI_MODEL = "gpt-4.1-mini"  # $0.40	$0.10	$1.60[m
 # OPENAI_MODEL = "gpt-4.1-nano"  # $0.10	$0.025	$0.40[m
 OPENAI_MODEL = "gpt-4o-mini"  # $0.15	$0.075	$0.60[m
[32m+[m
[32m+[m[32msentence_endings = [".", "!", "?", "...", "!..", "?.."][m
[1mdiff --git a/main.py b/main.py[m
[1mindex f19691f..c9f7991 100644[m
[1m--- a/main.py[m
[1m+++ b/main.py[m
[36m@@ -6,7 +6,7 @@[m [mfrom src.core.translator import Translator[m
 from src.core.translator_test import TranslatorTest[m
 from src.core.progress_manager import ProgressManager[m
 from src.parsers.html_parser import HTMLParser[m
[31m-from src.parsers.span_merger import SpanMerger[m
[32m+[m[32mfrom src.parsers.span_merger import process_lines[m
 from config import MODE, OPENAI_MODEL[m
 from src.prompts.prompt_template import save_prompt_to_file[m
 from src.gui.file_selector import select_file_gui, select_output_file_gui[m
[36m@@ -29,24 +29,21 @@[m [mdef get_translator():[m
 def create_batch(lines, start_index, batch_size=3):[m
     """[m
     –°–æ–∑–¥–∞–µ—Ç –±–∞—Ç—á —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –Ω–µ–π—Ä–æ—Å–µ—Ç—å[m
[31m-    [m
[32m+[m
     Args:[m
         lines: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫[m
         start_index: –∏–Ω–¥–µ–∫—Å –Ω–∞—á–∞–ª–∞ –±–∞—Ç—á–∞[m
         batch_size: —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞[m
[31m-    [m
[32m+[m
     Returns:[m
[31m-        list: –±–∞—Ç—á —Å—Ç—Ä–æ–∫ —Å –∏—Ö –∏–Ω–¥–µ–∫—Å–∞–º–∏[m
[32m+[m[32m        list: –±–∞—Ç—á —Å—Ç—Ä–æ–∫ —Å –∏—Ö –Ω–æ–º–µ—Ä–∞–º–∏[m
     """[m
     batch = [][m
     end_index = min(start_index + batch_size, len(lines))[m
[31m-    [m
[32m+[m
     for i in range(start_index, end_index):[m
[31m-        batch.append({[m
[31m-            "index": i + 1,  # –ù—É–º–µ—Ä–∞—Ü–∏—è —Å 1[m
[31m-            "line": lines[i].strip()[m
[31m-        })[m
[31m-    [m
[32m+[m[32m        batch.append({"line_number": i + 1, "line": lines[i].strip()})  # –ù—É–º–µ—Ä–∞—Ü–∏—è —Å 1[m
[32m+[m
     return batch[m
 [m
 [m
[36m@@ -70,7 +67,6 @@[m [mdef process_html_file(input_file, output_file=None):[m
     translator = get_translator()[m
     progress_manager = ProgressManager()[m
     parser = HTMLParser()[m
[31m-    merger = SpanMerger()[m
 [m
     try:[m
         # –ß–∏—Ç–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∞–π–ª–∞[m
[36m@@ -79,7 +75,7 @@[m [mdef process_html_file(input_file, output_file=None):[m
 [m
         # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–µ span —ç–ª–µ–º–µ–Ω—Ç—ã[m
         print("–û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã...")[m
[31m-        processed_lines = merger.process_lines(all_lines)[m
[32m+[m[32m        processed_lines = process_lines(all_lines)[m
 [m
         total_lines = len(processed_lines)[m
         progress_manager.set_total_lines(total_lines, input_file)[m
[36m@@ -95,38 +91,42 @@[m [mdef process_html_file(input_file, output_file=None):[m
         # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª –±–∞—Ç—á–∞–º–∏[m
         with open(output_file, "w", encoding="utf-8") as output_f:[m
             i = start_line[m
[31m-            [m
[32m+[m
             while i < total_lines:[m
                 # –°–æ–∑–¥–∞–µ–º –±–∞—Ç—á[m
                 batch = create_batch(processed_lines, i, batch_size=3)[m
[31m-                [m
[32m+[m
                 if not batch:[m
                     break[m
[31m-                [m
[32m+[m
                 # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –±–∞—Ç—á–µ —Å—Ç—Ä–æ–∫–∏ —Å span —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏[m
                 has_translatable_content = any([m
                     parser.has_span_elements(item["line"]) for item in batch[m
                 )[m
[31m-                [m
[32m+[m
                 if has_translatable_content:[m
                     print(f"–ü–µ—Ä–µ–≤–æ–¥–∏–º –±–∞—Ç—á —Å—Ç—Ä–æ–∫ {i+1}-{i+len(batch)}/{total_lines}")[m
[31m-                    [m
[32m+[m
                     # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞—Ç—á –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥[m
                     translated_batch = translator.translate_batch(batch)[m
[31m-                    [m
[32m+[m
                     # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏[m
                     for item in translated_batch:[m
                         output_f.write(item["translated_line"] + "\n")[m
[31m-                        progress_manager.update_progress(item["index"], translated=True)[m
[32m+[m[32m                        progress_manager.update_progress([m
[32m+[m[32m                            item["line_number"], translated=True[m
[32m+[m[32m                        )[m
                 else:[m
                     # –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π[m
                     for item in batch:[m
                         output_f.write(item["line"] + "\n")[m
[31m-                        progress_manager.update_progress(item["index"], translated=False)[m
[31m-                [m
[32m+[m[32m                        progress_manager.update_progress([m
[32m+[m[32m                            item["line_number"], translated=False[m
[32m+[m[32m                        )[m
[32m+[m
                 # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–∞—Ç—á—É[m
                 i += len(batch)[m
[31m-                [m
[32m+[m
                 # –í—ã–≤–æ–¥–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 10 —Å—Ç—Ä–æ–∫[m
                 if i % 10 == 0 or i >= total_lines:[m
                     print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: {i}/{total_lines}")[m
[36m@@ -142,7 +142,7 @@[m [mdef process_html_file(input_file, output_file=None):[m
             print(f"–í—ã—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤: {stats['output_tokens']:,}")[m
             print(f"–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: {stats['total_tokens']:,}")[m
             print("==========================")[m
[31m-            [m
[32m+[m
             # –í—ã–≤–æ–¥–∏–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞[m
             if hasattr(translator, "get_translation_cost"):[m
                 cost_report = translator.get_translation_cost()[m
[1mdiff --git a/prompt.txt b/prompt.txt[m
[1mindex c7118f3..e76520f 100644[m
[1m--- a/prompt.txt[m
[1m+++ b/prompt.txt[m
[36m@@ -1,30 +1,15 @@[m
[31m-You are a professional translator specializing in HTML content translation from English to Russian.[m
[32m+[m[32mYou are a translator. Translate HTML content from English to Russian.[m
 [m
[31m-Your task is to translate HTML lines while preserving all HTML structure, tags, attributes, and formatting.[m
[32m+[m[32mRules:[m
[32m+[m[32m- Translate only text within span elements[m
[32m+[m[32m- Keep all HTML structure unchanged[m
[32m+[m[32m- Return JSON array with line_number and translated_line fields[m
[32m+[m[32m- Use previous translation context for consistency[m
 [m
[31m-## Input Format[m
[31m-You will receive a JSON array of HTML lines, each with an index and content.[m
[31m-[m
[31m-## Translation Rules[m
[31m-1. **Translate only text content** within `<span>` elements from English to Russian[m
[31m-2. **Preserve all HTML structure** - tags, attributes, classes, IDs, etc.[m
[31m-3. **Maintain line order** and formatting exactly as in the input[m
[31m-4. **Keep non-translatable lines unchanged** - if a line has no span elements or no translatable content, return it as-is[m
[31m-5. **Use context from surrounding lines** for better translation accuracy[m
[31m-6. **Preserve special characters** and HTML entities[m
[31m-[m
[31m-## Output Format[m
[31m-Return a JSON array with the same structure, containing translated lines. Each object should have:[m
[31m-- "index": the original line index (integer)[m
[32m+[m[32mIMPORTANT: Your response must be a JSON array where each object has:[m
[32m+[m[32m- "line_number": the original line number (integer)[m
 - "translated_line": the translated HTML line (string)[m
 [m
[31m-## Important Notes[m
[31m-- Only translate text within `<span>` elements[m
[31m-- Keep all other HTML elements unchanged[m
[31m-- If text cannot be translated, leave it as-is[m
[31m-- Maintain the exact same HTML structure and attributes[m
[31m-- Use the context from multiple lines for better translation quality[m
[31m-[m
[31m-Translate the following batch of HTML lines from English to Russian:[m
[32m+[m[32m{previous_batch}[m
 [m
 {input}[m
\ No newline at end of file[m
[1mdiff --git a/src/core/translator.py b/src/core/translator.py[m
[1mindex 6cee4fa..f2218f3 100644[m
[1m--- a/src/core/translator.py[m
[1m+++ b/src/core/translator.py[m
[36m@@ -1,10 +1,9 @@[m
[32m+[m[32mimport json[m
[32m+[m[32mimport httpx[m
[32m+[m[32mfrom environs import Env[m
 from langchain_openai import ChatOpenAI[m
[31m-from langchain_core.messages import SystemMessage, HumanMessage[m
 from langchain_core.output_parsers import JsonOutputParser[m
 from langchain_core.prompts import PromptTemplate[m
[31m-from environs import Env[m
[31m-import httpx[m
[31m-import json[m
 from src.prompts.prompt_template import generate_prompt, get_json_schema[m
 from src.utils.cost_calculator import format_cost_summary[m
 from config import OPENAI_MODEL[m
[36m@@ -16,21 +15,20 @@[m [mclass Translator:[m
         env = Env()[m
         env.read_env(".env")[m
 [m
[31m-        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ .env[m
[31m-        self.api_key = env("OPENAI_API_KEY")[m
[31m-        proxy_url = env("PROXY_URL")[m
[31m-        proxy_login = env("PROXY_LOGIN")[m
[31m-        proxy_password = env("PROXY_PASSWORD")[m
[32m+[m[32m        self.api_key = env.str("OPENAI_API_KEY")[m
[32m+[m[32m        proxy_url = env.str("PROXY_URL")[m
[32m+[m[32m        proxy_login = env.str("PROXY_LOGIN")[m
[32m+[m[32m        proxy_password = env.str("PROXY_PASSWORD")[m
 [m
         # –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø—Ä–æ–∫—Å–∏ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π[m
         proxy_auth_url = ([m
             f"socks5://{proxy_login}:{proxy_password}@{proxy_url.split('://')[1]}"[m
         )[m
 [m
[31m-        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º HTTP-–∫–ª–∏–µ–Ω—Ç —Å –ø—Ä–æ–∫—Å–∏[m
[31m-        self.http_client = httpx.Client(proxy=proxy_auth_url)[m
[32m+[m[32m        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ–∫—Å–∏[m
[32m+[m[32m        self.http_client = httpx.Client(proxy=proxy_auth_url, timeout=60.0)[m
 [m
[31m-        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ChatGPT —Å –º–æ–¥–µ–ª—å—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏[m
[32m+[m[32m        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º LLM[m
         self.llm = ChatOpenAI([m
             api_key=self.api_key,[m
             model=OPENAI_MODEL,[m
[36m@@ -38,71 +36,53 @@[m [mclass Translator:[m
             http_client=self.http_client,[m
         )[m
 [m
[31m-        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç[m
[32m+[m[32m        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏[m
         self.system_prompt = generate_prompt()[m
[31m-[m
[31m-        # –°—á–µ—Ç—á–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤[m
         self.total_input_tokens = 0[m
         self.total_output_tokens = 0[m
         self.total_requests = 0[m
[31m-[m
[31m-    def translate_line(self, html_line):[m
[31m-        """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)"""[m
[31m-        try:[m
[31m-            # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –≤–≤–æ–¥–æ–º[m
[31m-            messages = [[m
[31m-                SystemMessage(content=self.system_prompt),[m
[31m-                HumanMessage(content=f"Input: {html_line}\nOutput:"),[m
[31m-            ][m
[31m-[m
[31m-            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ ChatGPT[m
[31m-            response = self.llm.invoke(messages)[m
[31m-[m
[31m-            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã[m
[31m-            if hasattr(response, "response_metadata") and response.response_metadata:[m
[31m-                usage = response.response_metadata.get("token_usage", {})[m
[31m-                self.total_input_tokens += usage.get("prompt_tokens", 0)[m
[31m-                self.total_output_tokens += usage.get("completion_tokens", 0)[m
[31m-                self.total_requests += 1[m
[31m-[m
[31m-            return response.content.strip()[m
[31m-[m
[31m-        except Exception as e:[m
[31m-            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ —Å—Ç—Ä–æ–∫–∏: {e}")[m
[31m-            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É[m
[31m-            return html_line[m
[32m+[m[32m        self.last_translated_batch = None  # –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –±–∞—Ç—á–∞[m
 [m
     def translate_batch(self, batch):[m
[31m-        """[m
[31m-        –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –±–∞—Ç—á —Å—Ç—Ä–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º output_format[m
[31m-[m
[31m-        Args:[m
[31m-            batch: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ 'index' –∏ 'line'[m
[31m-[m
[31m-        Returns:[m
[31m-            list: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ 'index' –∏ 'translated_line'[m
[31m-        """[m
[32m+[m[32m        """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –±–∞—Ç—á —Å—Ç—Ä–æ–∫ –∏—Å–ø–æ–ª—å–∑—É—è PromptTemplate —Å –∏—Å—Ç–æ—Ä–∏–µ–π"""[m
         try:[m
             # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ[m
             input_data = json.dumps(batch, ensure_ascii=False, indent=2)[m
 [m
[31m-            # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Å–µ—Ä –¥–ª—è JSON —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π[m
[32m+[m[32m            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é[m
[32m+[m[32m            previous_batch_text = ""[m
[32m+[m[32m            if self.last_translated_batch:[m
[32m+[m[32m                previous_batch_text = ([m
[32m+[m[32m                    "Previous translated batch for context:\n"[m
[32m+[m[32m                    f"{json.dumps(self.last_translated_batch, ensure_ascii=False, indent=2)}\n"[m
[32m+[m[32m                )[m
[32m+[m
[32m+[m[32m            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç —à–∞–±–ª–æ–Ω[m
[32m+[m[32m            prompt_template = PromptTemplate.from_template(self.system_prompt)[m
[32m+[m
[32m+[m[32m            # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Å–µ—Ä[m
             output_parser = JsonOutputParser(pydantic_object=get_json_schema())[m
 [m
[31m-            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç —Å output_format[m
[31m-            prompt = PromptTemplate([m
[31m-                template=self.system_prompt, input_variables=["input"][m
[32m+[m[32m            # –í—ã–ø–æ–ª–Ω—è–µ–º —Ü–µ–ø–æ—á–∫—É –ø–æ —á–∞—Å—Ç—è–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤[m
[32m+[m[32m            prompt_value = prompt_template.invoke([m
[32m+[m[32m                {"input": input_data, "previous_batch": previous_batch_text}[m
             )[m
[32m+[m[32m            llm_response = self.llm.invoke(prompt_value)[m
[32m+[m[32m            response = output_parser.invoke(llm_response)[m
 [m
[31m-            # –°–æ–∑–¥–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Å output_format[m
[31m-            chain = prompt | self.llm | output_parser[m
[32m+[m[32m            self.total_requests += 1[m
 [m
[31m-            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å[m
[31m-            response = chain.invoke({"input": input_data})[m
[32m+[m[32m            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–∞—Ç—á –∫–∞–∫ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞[m
[32m+[m[32m            self.last_translated_batch = response[m
 [m
[31m-            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–∫–µ–Ω–æ–≤ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)[m
[31m-            # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Å output_parser —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞[m
[31m-            self.total_requests += 1[m
[32m+[m[32m            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–∫–µ–Ω–∞—Ö –∏–∑ –ø—Ä–æ–º–µ–∂—É—Ç